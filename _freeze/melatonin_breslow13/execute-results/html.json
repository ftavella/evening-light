{
  "hash": "dea1a551f4484a0b0214b32754a5b90b",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: Breslow13 model\nformat:\n  html:\n    code-fold: true\n    grid:\n      margin-width: 100px\nexecute:\n  freeze: auto\nbibliography: references.bib\nmargin-width: 100px\n---\n\n\n\nWe implemented the melatonin supression model from Breslow et al. 2013 [@breslow_mathematical_2013] that expands and improves a previous model [@st_hilaire_physiologically_2007]. \nThe circadian part of the model is given by:\n\n$$\n\\frac{dn}{dt} = \\alpha (1-n) - \\beta n\n$$\n\nwhere\n\n$$\n\\alpha = \\alpha_0 \\left( \\frac{I}{I_0} \\right)^p \\frac{I}{I + I_1}\n$$\n\n> ðŸš¨ In the article, the multiplication by 60 on $\\frac{dn}{dt}$ is missing\n\n$$\n\\frac{dx}{dt} = \\frac{1}{\\kappa} \\left[ x_c + \\gamma \\left( \\frac{x}{3} + \\frac{4x}{3} - \\frac{256}{105} x^7 \\right) + B + \\eta M \\right]\n$$\n\n$$\n\\frac{dx_c}{dt} = \\frac{1}{\\kappa} \\left\\{ \\frac{B x_c}{3} - x \\left[\\left( \\frac{24}{f \\tau_c} \\right)^2  + K B \\right] - \\xi M \\right\\}\n$$\n\n> ðŸš¨ In the article, the brackets after $-x$ are missing, which is not correct based on `Hilaire07` and `Jewett00` from `circadian`\n\nwhere \n\n$$\nM = \\frac{M_{\\text{max}}}{1 + \\exp(\\frac{H_{\\text{sat} - H_2}}{\\sigma})}\n$$\n\nMelatonin dynamics are given by\n\n$$\n\\frac{dH_{1}}{dt} = - \\beta_{IP} H_{1} + A(\\phi) (1 - mB) S(H1, B)\n$$\n\n$$\n\\frac{dH_{2}}{dt} = \\beta_{IP} H_{1} - \\beta_{CP} H_{2} + \\beta_{AP} H_{3}\n$$\n\n$$\n\\frac{dH_{3}}{dt} = - \\beta_{AP} H_{3}\n$$\n\nwhere $H_{1}$ is the pineal melatonin, $H_{2}$ is the plasma melatonin, and $H_{3}$ is the exogenous melatonin. Also\n\n$$\n\\phi = \\tan^{-1} \\left( \\frac{x}{x_c} \\right)\n$$\n\n> ðŸš¨ Note that this is different from [@st_hilaire_physiologically_2007; @abeysuriya_unified_2018] where they do $\\tan^{-1}(x_c/x)$.  \n\n$$\nS(H_1, B) =  \n\\begin{cases}\n  0 & \\text{if} \\ \\ \\ H_1 < 0.001 \\ \\ \\text{and} \\ \\ (1 - mB) < 0 \\\\\n  1 & \\text{otherwise}\n\\end{cases}\n$$\n\nthe latter being a function to avoid negative values of $H_1$ for sudden spikes in light. Melatonin synthesis is given by\n\n$$\nA(\\phi) = \n\\begin{cases}\n  a\\left[ \\frac{1 - e^{-\\delta M_{2\\pi}(\\phi_{\\text{on} - \\phi})}}{1 - e^{-\\delta M_{2\\pi}(\\phi_{\\text{on}} - \\phi_{\\text{off}})}} \\right] & \\text{if} \\ \\ \\ \\phi < \\phi_{\\text{on}} \\ \\ \\ \\ \\text{and} \\ \\ \\ \\ \\phi > \\phi_{\\text{off}} \\\\\n  ae^{-r M_{2\\pi}(\\phi_{\\text{on} - \\phi_{\\text{off}}})} & \\text{if} \\ \\ \\  \\phi_{\\text{on}} < \\phi < \\phi_{\\text{off}}\n\\end{cases}\n$$\n\nwhere $M_{2\\pi}$ is the modulo function. \n\n> ðŸš¨ The value of the parameter $K$ is not on the article but it can be taken to be 0.55 based on `Jewet99` and `Hilaire07`\n\n> ðŸš¨ Parameters on the paper are given in units of seconds. So we have to convert them to hours to match all the previous models on `circadian`. We multiplied $\\beta_{IP}$, $\\beta_{CP}$, $\\beta_{AP}$, and $a$ by 3600.\n\n> ðŸš¨ Phase thresholds on the paper are given outside the range $[-\\pi, \\pi]$ but our phase calculation lies within that range. So we do $\\hat{\\phi_{\\text{on}}} = \\phi_{\\text{on}} - 2\\pi$ (same for $\\phi_{\\text{off}}$)\n\n::: {#cell-simulation .cell execution_count=2}\n``` {.python .cell-code}\nmodel = Breslow13()\ntrajectory = model.integrate(time, input=light)\n\nx = trajectory.states[:, 0]\nxc = trajectory.states[:, 1]\nH1 = trajectory.states[:, 3]\nH2 = trajectory.states[:, 4]\nphase = np.arctan2(x, xc)\n\nfig, axs = plt.subplots(3, 1, sharex=True, figsize=(12, 8))\n\n# x, xc, and light\np_x = axs[0].plot(time, x, label='x')\np_xc = axs[0].plot(time, xc, label='xc')\nlight_changes = np.diff(light)\nlight_on = np.where(light_changes > 0)[0]\nlight_off = np.where(light_changes < 0)[0]\nlight_off = np.append(light_off, len(light) - 1)\nfor on, off in zip(light_on, light_off):\n    axs[0].axvspan(time[on], time[off], color='yellow', alpha=0.4)\nyellow_patch = plt.Rectangle((0, 0), 1, 1, fc=\"yellow\", alpha=0.4)\naxs[0].legend([p_x[0], p_xc[0], yellow_patch], ['x', 'xc', 'Light'],\n              loc='upper left')\naxs[0].set_ylabel('Circadian state (a.u.)')\n\n# phase\naxs[1].plot(time, phase, label='Phase')\naxs[1].axhline(y=model.phi_on, color='gray', linestyle='--',)\naxs[1].axhline(y=model.phi_off, color='gray', linestyle='--',)\nplaces_on_1 = phase < model.phi_on\nplaces_on_2 = phase > model.phi_off\nplaces_on = np.where(np.logical_and(places_on_1,\n                                    places_on_2))[0]\nsynthesis_on = np.zeros_like(phase)\nsynthesis_on[places_on] = 1.0\nsynthesis_changes = np.diff(synthesis_on)\non_places = np.where(synthesis_changes > 0)[0]\noff_places = np.where(synthesis_changes < 0)[0]\nfor on, off in zip(on_places, off_places):\n    axs[1].axvspan(time[on], time[off], color='gray', alpha=0.4)\nfor on, off in zip(light_on, light_off):\n    axs[1].axvspan(time[on], time[off], color='yellow', alpha=0.4)\ngray_patch = plt.Rectangle((0, 0), 1, 1, fc=\"gray\", alpha=0.4)\naxs[1].legend([gray_patch], ['Synthesis on'], loc='upper left')\naxs[1].set_ylabel('Phase ' + r'$(\\tan^{-1}(x/x_c))$')\naxs[1].set_yticks(np.linspace(-np.pi, np.pi, 5))\naxs[1].set_yticklabels(['$-\\pi$', '$-\\pi/2$', '0', '$\\pi/2$', '$\\pi$'])\n\n# melatonin\naxs[2].plot(time, H1, label='Pineal')\naxs[2].plot(time, H2, label='Plasma')\nfor on, off in zip(light_on, light_off):\n    axs[2].axvspan(time[on], time[off], color='yellow', alpha=0.4)\naxs[2].legend(loc='upper left')\naxs[2].set_xlabel('Time (hours)')\naxs[2].set_ylabel('Melatonin (pmol/L)')\nplt.show()\n```\n\n::: {.cell-output .cell-output-display}\n![Model simulation](melatonin_breslow13_files/figure-html/simulation-output-1.png){#simulation width=975 height=651}\n:::\n:::\n\n\n> ðŸš¨ We are getting really low values of peak melatonin (based on [@st_hilaire_physiologically_2007] it should be more around 300). We need to find out why.\n\n",
    "supporting": [
      "melatonin_breslow13_files\\figure-html"
    ],
    "filters": [],
    "includes": {}
  }
}